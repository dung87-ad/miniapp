<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tokyo Sakura - Ultimate System V3</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* HỆ THỐNG BIẾN MÀU SẮC DESIGN SYSTEM */
        :root {
            --primary: #ff80ab; /* Hồng Sakura chính */
            --primary-dark: #f06292;
            --accent: #ad1457;
            --bg-light: #fff5f7;
            --bg-gradient: linear-gradient(135deg, #fff5f7 0%, #fce4ec 100%);
            --glass: rgba(255, 255, 255, 0.9);
            --glass-border: rgba(255, 255, 255, 0.5);
            --text-main: #4a148c;
            --text-sub: #880e4f;
            --success: #00c853;
            --warning: #ffab00;
            --shadow: 0 10px 25px rgba(255, 128, 171, 0.2);
        }

        /* RESET & TỐI ƯU TRẢI NGHIỆM NGƯỜI DÙNG */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            scrollbar-width: none; /* Ẩn scrollbar Firefox */
        }
        *::-webkit-scrollbar { display: none; } /* Ẩn scrollbar Chrome/Safari */

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-gradient);
            color: var(--text-main);
            margin: 0;
            padding: 12px;
            padding-bottom: 160px; /* Chừa khoảng trống cho Footer thanh toán */
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* HIỆU ỨNG CÁNH HOA ANH ĐÀO RƠI (CANVAS-LESS) */
        .sakura-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; pointer-events: none;
        }
        .petal {
            position: absolute;
            background: #ffc1e3;
            border-radius: 150% 0 150% 0;
            animation: fall linear infinite;
        }
        @keyframes fall {
            0% { transform: translateY(-10vh) rotate(0deg); opacity: 0; }
            10% { opacity: 0.8; }
            100% { transform: translateY(110vh) rotate(360deg); opacity: 0; }
        }

        /* UI COMPONENT: GLASSMORPHISM CARD */
        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: var(--shadow);
            margin-bottom: 15px;
        }

        /* 1. THANH TRẠNG THÁI HỆ THỐNG (TOP BAR) */
        .top-system-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 18px;
            font-size: 11px;
            font-weight: 800;
            color: var(--accent);
            letter-spacing: 0.5px;
        }
        .sys-clock { display: flex; align-items: center; gap: 6px; }
        .sys-battery { display: flex; align-items: center; gap: 8px; }
        .battery-shell {
            width: 22px; height: 11px; border: 1.5px solid var(--accent);
            border-radius: 3px; position: relative; padding: 1px;
        }
        .battery-bar { height: 100%; background: var(--success); border-radius: 1px; transition: 0.4s; }
        .battery-shell::after {
            content: ''; position: absolute; right: -4px; top: 2px;
            width: 3px; height: 4px; background: var(--accent); border-radius: 0 1px 1px 0;
        }

        /* 2. THÔNG TIN NGƯỜI DÙNG (USER PROFILE) */
        .user-section {
            display: flex; gap: 10px; align-items: stretch;
        }
        .user-info-box {
            flex: 1; padding: 15px;
            display: flex; align-items: center; gap: 15px;
        }
        .user-avatar {
            width: 55px; height: 55px; border-radius: 50%;
            border: 3px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            object-fit: cover;
        }
        .user-detail b { font-size: 16px; display: block; color: var(--text-main); }
        .user-detail span { font-size: 10px; font-weight: 700; color: var(--primary-dark); display: block; }
        
        .menu-toggle-btn {
            width: 55px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 22px; color: var(--primary);
        }

        /* 3. DANH MỤC SẢN PHẨM (ACCORDION STYLE) */
        .cat-item { overflow: hidden; }
        .cat-header {
            padding: 20px; display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; font-weight: 800; font-size: 15px;
        }
        .cat-header i.chevron { transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .cat-header.active i.chevron { transform: rotate(180deg); color: var(--primary); }
        
        .cat-content { display: none; padding: 10px; border-top: 1px dashed rgba(255, 128, 171, 0.3); }

        /* STATUS LED SERVER */
        .server-status {
            padding: 5px 12px; font-size: 10px; font-weight: 900;
            color: var(--success); display: flex; align-items: center; gap: 8px;
        }
        .led-blink {
            width: 8px; height: 8px; background: var(--success);
            border-radius: 50%; box-shadow: 0 0 8px var(--success);
            animation: led-flash 1.2s infinite;
        }
        @keyframes led-flash { 0%, 100% { opacity: 1; } 50% { opacity: 0.2; } }

        /* SẢN PHẨM */
        .product-card-wrap { margin-bottom: 10px; }
        .product-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px; border-radius: 18px; background: rgba(255,255,255,0.4);
            border: 2px solid transparent; transition: 0.3s;
        }
        .product-item.selected {
            background: var(--primary); color: white;
            border-color: var(--accent); transform: scale(0.98);
        }
        .product-item .p-name { font-weight: 700; font-size: 14px; }
        .product-item .p-price { font-weight: 900; color: var(--accent); }
        .product-item.selected .p-price { color: white; }

        /* BỘ CHỌN NGÀY (DURATION) */
        .duration-box {
            display: none; grid-template-columns: repeat(3, 1fr); gap: 10px;
            padding: 12px; animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        .day-btn {
            background: white; padding: 10px; border-radius: 12px;
            text-align: center; font-size: 11px; font-weight: 800;
            color: var(--primary); border: 1.5px solid var(--primary-soft);
        }
        .day-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

        /* 4. FOOTER THANH TOÁN (FLOATING ACTION BAR) */
        .footer-payment {
            position: fixed; bottom: 0; left: 0; right: 0;
            padding: 25px; background: white; border-radius: 30px 30px 0 0;
            box-shadow: 0 -15px 40px rgba(0,0,0,0.1);
            z-index: 1000; display: none;
            animation: footerUp 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        @keyframes footerUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .pay-flex { display: flex; justify-content: space-between; align-items: center; }
        .pay-text b { display: block; font-size: 14px; color: var(--text-sub); }
        .pay-text .total-price { font-size: 26px; font-weight: 900; color: var(--accent); }
        
        .btn-confirm {
            background: var(--primary); color: white; border: none;
            padding: 16px 35px; border-radius: 20px; font-weight: 900;
            box-shadow: 0 8px 15px rgba(255, 128, 171, 0.4);
        }

        /* 5. MENU DRAWER & SUB-PAGES */
        .drawer-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px); z-index: 2000; display: none;
        }
        .drawer-content {
            position: fixed; top: 0; right: 0; width: 85%; height: 100%;
            background: white; z-index: 2001; transform: translateX(100%);
            transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 60px 25px;
        }
        .drawer-content.open { transform: translateX(0); }
        .drawer-user { text-align: center; margin-bottom: 40px; }
        .menu-link {
            padding: 18px; border-bottom: 1px solid #f5f5f5;
            display: flex; align-items: center; gap: 15px;
            font-weight: 700; color: #444; transition: 0.2s;
        }
        .menu-link:active { background: #fff1f5; color: var(--primary); }

        /* TRANG THANH TOÁN QR */
        .sub-page {
            position: fixed; inset: 0; background: var(--bg-gradient);
            z-index: 3000; padding: 25px; display: none; overflow-y: auto;
        }
        .nav-back { font-weight: 900; color: var(--accent); margin-bottom: 25px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="sakura-container" id="sakura-box"></div>
    <div class="drawer-overlay" id="overlay" onclick="closeDrawer()"></div>

    <div id="view-main">
        <div class="top-system-bar glass-card">
            <div class="sys-clock">
                <i class="fa-regular fa-clock"></i> <span id="clock-display">00:00:00</span>
                <span style="opacity: 0.3; margin: 0 5px;">|</span>
                <span id="date-display">01/01/2026</span>
            </div>
            <div class="sys-battery">
                <span id="bat-text">--%</span>
                <div class="battery-shell"><div id="bat-level" class="battery-bar" style="width: 0%"></div></div>
            </div>
        </div>

        <div class="user-section">
            <div class="user-info-box glass-card">
                <img id="u-avatar" src="https://ui-avatars.com/api/?background=ff80ab&color=fff" class="user-avatar">
                <div class="user-detail">
                    <b id="u-full-name">Người dùng Telegram</b>
                    <span id="u-handle">@username</span>
                    <span id="u-tgid" style="opacity: 0.5;">ID: 000000000</span>
                </div>
            </div>
            <div class="menu-toggle-btn glass-card" onclick="openDrawer()">
                <i class="fa-solid fa-bars-staggered"></i>
            </div>
        </div>

        <div id="shop-root"></div>
    </div>

    <div class="drawer-content" id="drawer">
        <div class="drawer-user">
            <img id="d-avatar" src="" style="width: 85px; height: 85px; border-radius: 50%; border: 4px solid var(--primary);">
            <h3 id="d-name" style="margin: 15px 0 5px;">Username</h3>
            <p id="d-id" style="font-size: 11px; opacity: 0.5; font-weight: 800;">ID: 000000000</p>
        </div>

        <div class="menu-link" onclick="tg.showAlert('Tính năng lịch sử đang đồng bộ...')">
            <i class="fa-solid fa-receipt" style="color: var(--primary);"></i> Lịch sử mua hàng
        </div>

        <p style="font-size: 10px; font-weight: 900; color: var(--accent); margin: 30px 0 10px 15px; letter-spacing: 1px;">TRUNG TÂM HỖ TRỢ</p>
        <div class="menu-link" onclick="tg.openTelegramLink('https://t.me/tokyo_admin_1')">
            <i class="fa-solid fa-user-tie"></i> Admin Tổng (Giao dịch)
        </div>
        <div class="menu-link" onclick="tg.openTelegramLink('https://t.me/tokyo_tech')">
            <i class="fa-solid fa-microchip"></i> Kỹ thuật viên (Cài đặt)
        </div>
        <div class="menu-link" onclick="tg.openTelegramLink('https://t.me/tokyo_cskh')">
            <i class="fa-solid fa-headset"></i> Khiếu nại & Hoàn tiền
        </div>

        <button class="btn-confirm" style="width: 100%; margin-top: 50px; background: #f5f5f5; color: #888; box-shadow: none;" onclick="closeDrawer()">ĐÓNG MENU</button>
    </div>

    <div class="footer-payment" id="footer-pay">
        <div class="pay-flex">
            <div class="pay-text">
                <b id="f-selected-name">Tên sản phẩm</b>
                <span class="total-price" id="f-total-price">0đ</span>
            </div>
            <button class="btn-confirm" onclick="openPaymentPage()">THANH TOÁN</button>
        </div>
    </div>

    <div id="sub-page-payment" class="sub-page">
        <div class="nav-back" onclick="closeSubPage()"><i class="fa-solid fa-arrow-left"></i> TRỞ VỀ CỬA HÀNG</div>
        <div class="glass-card" style="padding: 25px; text-align: center;">
            <h3>Thanh toán hóa đơn</h3>
            <img id="qr-code" style="width: 100%; border-radius: 20px; border: 2px solid #fff1f5; margin: 15px 0;">
            <div id="bank-details" style="text-align: left; font-size: 13px; line-height: 1.8; background: white; padding: 15px; border-radius: 15px;"></div>
            <button class="btn-confirm" style="width: 100%; margin-top: 25px;" onclick="tg.showAlert('Đã gửi yêu cầu kiểm tra giao dịch!')">TÔI ĐÃ CHUYỂN KHOẢN</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();

        // 1. CẤU HÌNH DỮ LIỆU SẢN PHẨM
        const MASTER_DATA = [
            {
                id: 'cat-hack',
                name: 'HACK FREE FIRE VIP',
                type: 'rent', // Loại thuê theo ngày
                items: [
                    { n: 'HG Cheat', p: 5000 },
                    { n: 'Br Mod VIP', p: 5000 },
                    { n: 'Zygame', p: 7000 },
                    { n: 'Flu', p: 5000 },
                    { n: 'Drip Client', p: 10000 }
                ]
            },
            {
                id: 'cat-cloud',
                name: 'CLOUD PHONE TREO GAME',
                type: 'rent',
                items: [
                    { n: 'Redfinger', p: 85000 },
                    { n: 'CC Cloud', p: 90000 },
                    { n: 'Genplay', p: 80000 },
                    { n: 'VipPlayer', p: 105000 }
                ]
            },
            {
                id: 'cat-acc',
                name: 'TÀI KHOẢN FREE FIRE',
                type: 'buy', // Loại mua đứt
                items: [
                    { n: 'Acc FF Level 5', p: 5000 },
                    { n: 'Acc FF Level 15', p: 15000 }
                ]
            }
        ];

        let cartState = {
            category: null,
            productName: null,
            basePrice: 0,
            days: 0,
            element: null
        };

        // 2. CẬP NHẬT HỆ THỐNG (TIME/BATTERY)
        function syncSystem() {
            const now = new Date();
            document.getElementById('clock-display').innerText = now.toLocaleTimeString('vi-VN', { hour12: false });
            document.getElementById('date-display').innerText = now.toLocaleDateString('vi-VN');
            
            if (navigator.getBattery) {
                navigator.getBattery().then(b => {
                    const l = Math.floor(b.level * 100);
                    document.getElementById('bat-text').innerText = l + "%";
                    document.getElementById('bat-level').style.width = l + "%";
                });
            }
        }
        setInterval(syncSystem, 1000);
        syncSystem();

        // 3. RENDER CORE
        function renderShop() {
            const root = document.getElementById('shop-root');
            let html = '';
            
            MASTER_DATA.forEach(cat => {
                html += `
                <div class="glass-card cat-item">
                    <div class="cat-header" onclick="handleToggleCat(this, '${cat.id}')">
                        <span>${cat.name}</span>
                        <i class="fa-solid fa-chevron-down chevron"></i>
                    </div>
                    <div class="cat-content" id="${cat.id}">
                        <div class="server-status"><div class="led-blink"></div> HỆ THỐNG MÁY CHỦ TRỰC TUYẾN</div>
                        ${cat.items.map(item => {
                            const uniqueId = btoa(item.n).substring(0, 8);
                            return `
                            <div class="product-card-wrap">
                                <div class="product-item" id="item-${uniqueId}" onclick="handleItemSelect('${cat.id}', '${cat.type}', '${item.n}', ${item.p}, 'item-${uniqueId}')">
                                    <span class="p-name">${item.n}</span>
                                    <span class="p-price">${item.p.toLocaleString()}đ${cat.type === 'rent' ? '/ngày' : ''}</span>
                                </div>
                                ${cat.type === 'rent' ? `
                                <div class="duration-box" id="dur-${uniqueId}">
                                    <div class="day-btn" onclick="handleDaySelect(1, this)">1 Ngày</div>
                                    <div class="day-btn" onclick="handleDaySelect(7, this)">7 Ngày</div>
                                    <div class="day-btn" onclick="handleDaySelect(30, this)">30 Ngày</div>
                                </div>` : ''}
                            </div>`;
                        }).join('')}
                    </div>
                </div>`;
            });
            root.innerHTML = html;
        }

        // 4. LOGIC CHỌN SẢN PHẨM & NGÀY
        function handleToggleCat(el, id) {
            const content = document.getElementById(id);
            const isOpen = content.style.display === 'block';
            
            if (isOpen) clearSelection(); // Đóng danh mục thì reset chọn

            content.style.display = isOpen ? 'none' : 'block';
            el.classList.toggle('active');
        }

        function handleItemSelect(catId, catType, name, price, elId) {
            const el = document.getElementById(elId);
            const uniqueId = elId.replace('item-', '');

            // Nếu bấm lại cái cũ -> Hủy chọn
            if (cartState.productName === name) {
                clearSelection();
                return;
            }

            clearSelection(); // Xóa chọn cũ

            cartState = {
                category: catId,
                type: catType,
                productName: name,
                basePrice: price,
                days: (catType === 'buy' ? 1 : 0),
                element: el
            };

            el.classList.add('selected');
            
            if (catType === 'rent') {
                document.getElementById('dur-' + uniqueId).style.display = 'grid';
                document.getElementById('footer-pay').style.display = 'block';
                updateFooterUI(false);
            } else {
                document.getElementById('footer-pay').style.display = 'block';
                updateFooterUI(true);
            }
        }

        function handleDaySelect(day, btn) {
            const btns = btn.parentElement.querySelectorAll('.day-btn');
            btns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            cartState.days = day;
            updateFooterUI(true);
        }

        function updateFooterUI(ready) {
            const fName = document.getElementById('f-selected-name');
            const fPrice = document.getElementById('f-total-price');

            if (!ready) {
                fName.innerText = cartState.productName;
                fPrice.innerText = "CHỌN NGÀY...";
                return;
            }

            // Tính giá ưu đãi
            let mult = cartState.days;
            if (cartState.days === 7) mult = 6.2; // Thuê tuần giảm giá
            if (cartState.days === 30) mult = 24;  // Thuê tháng giảm mạnh

            const total = Math.floor(cartState.basePrice * mult);
            fName.innerText = `${cartState.productName} (${cartState.days} Ngày)`;
            fPrice.innerText = total.toLocaleString() + "đ";
        }

        function clearSelection() {
            if (cartState.element) {
                cartState.element.classList.remove('selected');
                const uniqueId = cartState.element.id.replace('item-', '');
                const dBox = document.getElementById('dur-' + uniqueId);
                if (dBox) {
                    dBox.style.display = 'none';
                    dBox.querySelectorAll('.day-btn').forEach(b => b.classList.remove('active'));
                }
            }
            cartState = { category: null, productName: null, basePrice: 0, days: 0, element: null };
            document.getElementById('footer-pay').style.display = 'none';
        }

        // 5. THANH TOÁN & QR
        function openPaymentPage() {
            if (cartState.days === 0) {
                tg.showAlert("Vui lòng chọn số ngày sử dụng!");
                return;
            }
            document.getElementById('sub-page-payment').style.display = 'block';
            
            const amountStr = document.getElementById('f-total-price').innerText.replace(/\D/g, '');
            const transCode = "TOKYO" + Math.floor(100000 + Math.random() * 899999);
            
            document.getElementById('qr-code').src = `https://img.vietqr.io/image/MB-79991312006-compact2.png?amount=${amountStr}&addInfo=${transCode}&accountName=TOKYO%20SHOP`;
            
            document.getElementById('bank-details').innerHTML = `
                <div style="margin-bottom:8px"><b>NGÂN HÀNG:</b> MB BANK (QUÂN ĐỘI)</div>
                <div style="margin-bottom:8px"><b>SỐ TÀI KHOẢN:</b> 79991312006</div>
                <div style="margin-bottom:8px"><b>CHỦ TK:</b> TOKYO SHOP</div>
                <div style="margin-bottom:8px"><b>SỐ TIỀN:</b> <span style="color:var(--accent);font-weight:900">${parseInt(amountStr).toLocaleString()}đ</span></div>
                <div><b>NỘI DUNG:</b> <span style="color:red;font-weight:900">${transCode}</span></div>
            `;
        }

        function closeSubPage() { document.getElementById('sub-page-payment').style.display = 'none'; }

        // 6. MENU DRAWER
        function openDrawer() {
            document.getElementById('drawer').classList.add('open');
            document.getElementById('overlay').style.display = 'block';
        }
        function closeDrawer() {
            document.getElementById('drawer').classList.remove('open');
            document.getElementById('overlay').style.display = 'none';
        }

        // 7. KHỞI TẠO USER TELEGRAM
        const user = tg.initDataUnsafe?.user;
        if (user) {
            const fullName = (user.first_name || "") + " " + (user.last_name || "");
            document.getElementById('u-full-name').innerText = fullName || "Khách Hàng";
            document.getElementById('d-name').innerText = fullName || "Khách Hàng";
            document.getElementById('u-handle').innerText = user.username ? "@" + user.username : "@no_username";
            document.getElementById('u-tgid').innerText = "ID: " + user.id;
            document.getElementById('d-id').innerText = "ID: " + user.id;
            if (user.photo_url) {
                document.getElementById('u-avatar').src = user.photo_url;
                document.getElementById('d-avatar').src = user.photo_url;
            }
        }

        // CÁNH HOA RƠI
        const box = document.getElementById('sakura-box');
        for (let i = 0; i < 20; i++) {
            const p = document.createElement('div');
            p.className = 'petal';
            p.style.width = p.style.height = Math.random() * 10 + 8 + 'px';
            p.style.left = Math.random() * 100 + 'vw';
            p.style.animationDuration = Math.random() * 3 + 4 + 's';
            p.style.animationDelay = Math.random() * 5 + 's';
            box.appendChild(p);
        }

        renderShop();
    </script>
</body>
</html>
