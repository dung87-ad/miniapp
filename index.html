<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tokyo Sakura Shop - Final Master V5</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #ff80ab;
            --primary-dark: #f06292;
            --accent: #ad1457;
            --bg-gradient: linear-gradient(135deg, #fff5f7 0%, #fce4ec 100%);
            --glass: rgba(255, 255, 255, 0.92);
            --text-main: #4a148c;
            --success: #00c853;
            --shadow: 0 10px 30px rgba(255, 128, 171, 0.2);
        }

        /* RESET & BASE */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; 
            background: var(--bg-gradient); color: var(--text-main);
            margin: 0; padding: 12px; padding-bottom: 150px; min-height: 100vh; overflow-x: hidden;
        }

        /* HIỆU ỨNG HOA ANH ĐÀO 5 CÁNH (PURE CSS) */
        .sakura-container { position: fixed; inset: 0; z-index: -1; pointer-events: none; }
        .sakura { position: absolute; width: 25px; height: 25px; animation: sakura-fall linear infinite; }
        .petal {
            position: absolute; width: 12px; height: 14px; background: #ffc1e3;
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            box-shadow: inset 0 0 5px rgba(255,182,193,0.8);
        }
        .petal::after { content: ''; position: absolute; top: 2px; left: 5px; width: 2px; height: 4px; background: #ff80ab; border-radius: 50%; opacity: 0.6; } /* Nhụy hoa */
        .petal:nth-child(1) { transform: rotate(0deg) translateY(-8px); }
        .petal:nth-child(2) { transform: rotate(72deg) translateY(-8px); }
        .petal:nth-child(3) { transform: rotate(144deg) translateY(-8px); }
        .petal:nth-child(4) { transform: rotate(216deg) translateY(-8px); }
        .petal:nth-child(5) { transform: rotate(288deg) translateY(-8px); }

        @keyframes sakura-fall {
            0% { transform: translateY(-10vh) rotate(0deg) scale(0.8); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg) scale(1); opacity: 0; }
        }

        /* UI COMPONENT: GLASSMORPHISM */
        .glass { background: var(--glass); backdrop-filter: blur(15px); border-radius: 22px; border: 1px solid white; box-shadow: var(--shadow); }

        /* 4 Ô CHỈ SỐ HỆ THỐNG */
        .stats-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 18px; }
        .stat-item { padding: 12px 5px; text-align: center; border-radius: 18px; }
        .stat-item i { font-size: 18px; color: var(--primary); margin-bottom: 6px; display: block; }
        .stat-item b { font-size: 11px; display: block; color: var(--text-main); }
        .stat-item span { font-size: 9px; font-weight: 700; color: var(--accent); opacity: 0.7; }

        /* THANH THÔNG BÁO (TICKER) */
        .news-ticker { padding: 12px 18px; margin-bottom: 18px; display: flex; align-items: center; gap: 12px; }
        .news-ticker i { color: var(--primary); font-size: 18px; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        .news-ticker marquee { font-size: 12px; font-weight: 800; color: var(--accent); }

        /* CATEGORY & PRODUCTS */
        .cat-card { margin-bottom: 12px; overflow: hidden; transition: 0.3s; }
        .cat-header { padding: 18px 22px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .cat-header b { font-size: 15px; letter-spacing: 0.5px; }
        .cat-header i.chevron { transition: 0.4s; }
        .cat-header.active i.chevron { transform: rotate(180deg); color: var(--primary); }

        .cat-body { display: none; padding: 10px; border-top: 1px dashed rgba(255, 128, 171, 0.2); }

        .product-item {
            padding: 16px; border-radius: 18px; background: rgba(255,255,255,0.4); 
            margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;
            border: 2px solid transparent; transition: 0.3s; cursor: pointer;
        }
        .product-item.selected { 
            background: var(--primary); color: white; border-color: var(--accent);
            box-shadow: 0 5px 15px rgba(255, 128, 171, 0.4);
        }
        .product-item b { font-size: 14px; }
        .product-item .select-icon { font-size: 18px; opacity: 0; transition: 0.3s; }
        .product-item.selected .select-icon { opacity: 1; }

        /* DURATION SELECTOR (HIDDEN UNTIL SELECT) */
        .duration-grid { display: none; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 0 10px 15px; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .day-opt { 
            padding: 10px; background: white; border-radius: 12px; text-align: center; 
            font-size: 11px; font-weight: 800; color: var(--primary); border: 1.5px solid #fff1f5;
        }
        .day-opt.active { background: var(--accent); color: white; border-color: var(--accent); }

        /* LOADING SPINNER */
        .loader-overlay {
            position: fixed; inset: 0; background: rgba(255,255,255,0.85);
            z-index: 10000; display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .circle-loader {
            width: 50px; height: 50px; border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* FOOTER */
        .footer-buy {
            position: fixed; bottom: 0; left: 0; right: 0; padding: 25px;
            background: white; border-radius: 30px 30px 0 0;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.1); z-index: 2000;
            display: none; animation: up 0.4s ease;
        }
        @keyframes up { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* SUB PAGES & DRAWER */
        .sub-page { position: fixed; inset: 0; background: var(--bg-gradient); z-index: 5000; padding: 25px; display: none; overflow-y: auto; }
        .drawer { 
            position: fixed; inset: 0 0 0 auto; width: 85%; background: white; 
            z-index: 6000; transform: translateX(100%); transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 50px 25px; 
        }
        .drawer.active { transform: translateX(0); }
        .nav-head { font-size: 18px; font-weight: 900; color: var(--accent); margin-bottom: 30px; display: flex; align-items: center; gap: 10px; }

        .btn-confirm {
            background: var(--primary); color: white; border: none; padding: 16px;
            border-radius: 18px; font-weight: 900; width: 100%; font-size: 15px;
            box-shadow: 0 8px 20px rgba(255, 128, 171, 0.3); margin-top: 15px;
        }
    </style>
</head>
<body>

    <div class="sakura-container" id="sakura-box"></div>
    <div class="loader-overlay" id="loader"><div class="circle-loader"></div><b style="color:var(--primary)">HỆ THỐNG ĐANG XỬ LÝ...</b></div>

    <div class="glass" style="padding: 18px; display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
        <img id="u-avatar" src="https://ui-avatars.com/api/?name=U&background=ff80ab&color=fff" style="width: 55px; height: 55px; border-radius: 50%; border: 3px solid white;">
        <div style="flex: 1;">
            <b id="u-name" style="font-size: 16px;">Khách hàng</b>
            <div id="u-detail" style="font-size: 10px; font-weight: 700; opacity: 0.6; margin-top: 3px;">@username | ID: 000000</div>
        </div>
        <div class="glass" style="width: 45px; height: 45px; display: flex; align-items: center; justify-content: center;" onclick="openDrawer()">
            <i class="fa-solid fa-bars-staggered" style="color: var(--primary); font-size: 20px;"></i>
        </div>
    </div>

    <div class="stats-container">
        <div class="glass stat-item"><i class="fa-solid fa-wallet"></i><b>0đ</b><span>SỐ DƯ</span></div>
        <div class="glass stat-item"><i class="fa-solid fa-cart-shopping"></i><b>0</b><span>ĐƠN HÀNG</span></div>
        <div class="glass stat-item"><i class="fa-solid fa-crown"></i><b>BẠC</b><span>HỘI VIÊN</span></div>
        <div class="glass stat-item"><i class="fa-solid fa-fire"></i><b>0</b><span>POINTS</span></div>
    </div>

    <div class="glass news-ticker">
        <i class="fa-solid fa-bullhorn"></i>
        <marquee scrollamount="5">Chào mừng đến với Tokyo Sakura! Hệ thống Hack VIP và Cloud Phone tự động đã sẵn sàng. Chúc bạn leo rank thành công!</marquee>
    </div>

    <div id="shop-root"></div>

    <div class="footer-buy" id="footer-buy">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <b id="f-name" style="color: var(--accent); font-size: 14px;">Tên sản phẩm</b>
                <div id="f-price" style="font-size: 26px; font-weight: 900; color: var(--accent);">---</div>
            </div>
            <button class="btn-confirm" style="width: auto; padding: 15px 30px; margin-top: 0;" onclick="openPayFlow()">MUA NGAY</button>
        </div>
    </div>

    <div id="page-pay-select" class="sub-page">
        <div class="nav-head" onclick="closePage('page-pay-select')"><i class="fa-solid fa-circle-chevron-left"></i> PHƯƠNG THỨC</div>
        <div class="glass" style="padding: 25px; margin-bottom: 15px; display: flex; align-items: center; gap: 20px;" onclick="openQR()">
            <i class="fa-solid fa-building-columns" style="font-size: 28px; color: var(--primary);"></i>
            <div><b>ATM / MOMO / ZALOPAY</b><br><small style="color:var(--success); font-weight:bold;">Tự động - Nhận ngay 100%</small></div>
        </div>
        <div class="glass" style="padding: 25px;" onclick="openCard()">
            <i class="fa-solid fa-phone-volume" style="font-size: 28px; color: #fb8c00;"></i>
            <div><b>NẠP THẺ CÀO (AUTO)</b><br><small>Viettel, Mobi, Vina, Zing...</small></div>
        </div>
    </div>

    <div id="page-qr" class="sub-page">
        <div class="nav-head" onclick="closePage('page-qr')"><i class="fa-solid fa-arrow-left"></i> QUÉT MÃ QR</div>
        <div class="glass" style="padding: 25px; text-align: center;">
            <img id="qr-img" style="width: 100%; border-radius: 20px; border: 2px solid #fff1f5;">
            <div id="qr-info" style="text-align: left; margin-top: 20px; background: white; padding: 15px; border-radius: 15px; font-size: 13px; line-height: 1.8;"></div>
            <button class="btn-confirm" onclick="triggerLoading('Nạp tiền thành công! Vui lòng kiểm tra đơn hàng.')">TÔI ĐÃ CHUYỂN TIỀN</button>
        </div>
    </div>

    <div id="page-card" class="sub-page">
        <div class="nav-head" onclick="closePage('page-card')"><i class="fa-solid fa-arrow-left"></i> NẠP THẺ CÀO</div>
        <div class="glass" style="padding: 25px;">
            <select id="card-type" style="width:100%; padding:15px; margin-bottom:15px; border-radius:12px; border:1px solid #eee;">
                <option>Viettel</option><option>Mobifone</option><option>Vinaphone</option><option>Zing</option>
            </select>
            <input type="text" placeholder="Mã số thẻ (PIN)" style="width:100%; padding:15px; margin-bottom:15px; border-radius:12px; border:1px solid #eee;">
            <input type="text" placeholder="Số Seri thẻ" style="width:100%; padding:15px; margin-bottom:15px; border-radius:12px; border:1px solid #eee;">
            <button class="btn-confirm" onclick="triggerLoading('Thẻ đã được gửi! Chờ duyệt trong 1-5 phút.')">GỬI THẺ DUYỆT</button>
        </div>
    </div>

    <div id="page-history" class="sub-page">
        <div class="nav-head" onclick="closePage('page-history')"><i class="fa-solid fa-arrow-left"></i> LỊCH SỬ MUA</div>
        <div id="history-list">
            <div class="glass" style="padding: 20px; text-align: center; opacity: 0.5;">
                <i class="fa-solid fa-box-open" style="font-size: 40px; margin-bottom: 15px; display: block;"></i>
                Bạn chưa thực hiện giao dịch nào.
            </div>
        </div>
    </div>

    <div class="drawer" id="drawer">
        <div style="text-align: center; margin-bottom: 40px;">
            <img id="d-avatar" src="" style="width: 80px; height: 80px; border-radius: 50%; border: 4px solid var(--primary);">
            <h3 id="d-name" style="margin-top: 15px;">User</h3>
        </div>
        <div class="glass" style="padding: 15px; margin-bottom: 10px; font-weight: 800;" onclick="openPage('page-history')">
            <i class="fa-solid fa-clock-rotate-left" style="color:var(--primary); margin-right: 10px;"></i> Lịch sử mua hàng
        </div>
        <div style="padding: 15px; border-bottom: 1px solid #f5f5f5;" onclick="tg.openTelegramLink('https://t.me/tokyo_admin')"><i class="fa-solid fa-user-shield"></i> Admin: @tokyo_admin</div>
        <div style="padding: 15px; border-bottom: 1px solid #f5f5f5;" onclick="tg.openTelegramLink('https://t.me/tokyo_tech')"><i class="fa-solid fa-microchip"></i> Kỹ thuật: @tokyo_tech</div>
        <div style="padding: 15px; border-bottom: 1px solid #f5f5f5;" onclick="tg.openTelegramLink('https://t.me/tokyo_cskh')"><i class="fa-solid fa-headset"></i> CSKH: @tokyo_cskh</div>
        <button class="btn-confirm" style="background: #eee; color: #666; box-shadow: none; margin-top: 40px;" onclick="openDrawer()">ĐÓNG MENU</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();

        let state = { cat: null, name: null, price: 0, days: 0, el: null };

        const SHOP_DATA = [
            { id: 'hack', title: 'HACK FREE FIRE VIP', items: [{n:'HG Cheat',p:5000}, {n:'Br Mod VIP',p:5000}, {n:'Zygame',p:7000}, {n:'Flu',p:5000}, {n:'Drip Client',p:10000}] },
            { id: 'cloud', title: 'CLOUD PHONE TREO GAME', items: [{n:'Redfinger',p:85000}, {n:'CC Cloud',p:90000}, {n:'Genplay',p:80000}, {n:'VipPlayer',p:105000}] },
            { id: 'acc', title: 'TÀI KHOẢN FREE FIRE', items: [{n:'Acc FF Level 5',p:5000}, {n:'Acc FF Level 15',p:15000}] }
        ];

        function render() {
            let html = '';
            SHOP_DATA.forEach(cat => {
                html += `
                <div class="glass cat-card">
                    <div class="cat-header" onclick="toggleCat(this, '${cat.id}')">
                        <b>${cat.title}</b>
                        <i class="fa-solid fa-chevron-down chevron"></i>
                    </div>
                    <div class="cat-body" id="${cat.id}">
                        ${cat.items.map(i => {
                            const domId = i.n.replace(/\s+/g, '');
                            return `
                            <div class="prod-wrap">
                                <div class="product-item" id="item-${domId}" onclick="selectProduct('${cat.id}', '${i.n}', ${i.p}, this)">
                                    <b>${i.n}</b>
                                    <i class="fa-solid fa-circle-check select-icon"></i>
                                </div>
                                ${cat.id !== 'acc' ? `
                                <div class="duration-grid" id="dur-${domId}">
                                    <div class="day-opt" onclick="setDuration(1, this)">1 Ngày</div>
                                    <div class="day-opt" onclick="setDuration(7, this)">7 Ngày</div>
                                    <div class="day-opt" onclick="setDuration(30, this)">30 Ngày</div>
                                </div>` : ''}
                            </div>`;
                        }).join('')}
                    </div>
                </div>`;
            });
            document.getElementById('shop-root').innerHTML = html;
        }

        function toggleCat(el, id) {
            const body = document.getElementById(id);
            const isOpen = body.style.display === 'block';
            if (isOpen) resetSelection();
            body.style.display = isOpen ? 'none' : 'block';
            el.classList.toggle('active');
        }

        function selectProduct(cat, name, price, el) {
            if (state.name === name) { resetSelection(); return; }
            resetSelection();

            state = { cat, name, price, days: (cat === 'acc' ? 1 : 0), el };
            el.classList.add('selected');
            document.getElementById('footer-buy').style.display = 'block';
            document.getElementById('f-name').innerText = name;

            if (cat === 'acc') {
                document.getElementById('f-price').innerText = price.toLocaleString() + "đ";
            } else {
                const domId = name.replace(/\s+/g, '');
                document.getElementById('dur-' + domId).style.display = 'grid';
                document.getElementById('f-price').innerText = "Chọn ngày...";
            }
        }

        function setDuration(day, btn) {
            const parent = btn.parentElement;
            parent.querySelectorAll('.day-opt').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            state.days = day;
            let mult = (day === 7) ? 6.5 : (day === 30 ? 25 : day);
            let total = Math.floor(state.price * mult);
            document.getElementById('f-price').innerText = total.toLocaleString() + "đ";
        }

        function resetSelection() {
            if (state.el) {
                state.el.classList.remove('selected');
                const domId = state.name.replace(/\s+/g, '');
                const dur = document.getElementById('dur-' + domId);
                if (dur) {
                    dur.style.display = 'none';
                    dur.querySelectorAll('.day-opt').forEach(b => b.classList.remove('active'));
                }
            }
            state = { cat: null, name: null, price: 0, days: 0, el: null };
            document.getElementById('footer-buy').style.display = 'none';
        }

        function triggerLoading(msg) {
            document.getElementById('loader').style.display = 'flex';
            setTimeout(() => {
                document.getElementById('loader').style.display = 'none';
                tg.showAlert(msg);
                document.querySelectorAll('.sub-page').forEach(p => p.style.display = 'none');
                resetSelection();
            }, 3000);
        }

        // NAVIGATION
        function openPage(id) { document.getElementById(id).style.display = 'block'; if(id === 'page-history') openDrawer(); }
        function closePage(id) { document.getElementById(id).style.display = 'none'; }
        function openDrawer() { document.getElementById('drawer').classList.toggle('active'); }
        function openPayFlow() { if (state.days === 0) return tg.showAlert("Vui lòng chọn số ngày!"); openPage('page-pay-select'); }
        function openCard() { closePage('page-pay-select'); openPage('page-card'); }
        function openQR() {
            closePage('page-pay-select');
            openPage('page-qr');
            const price = document.getElementById('f-price').innerText.replace(/\D/g, '');
            const code = "TS" + Math.floor(1000 + Math.random() * 9000);
            document.getElementById('qr-img').src = `https://img.vietqr.io/image/MB-79991312006-compact2.png?amount=${price}&addInfo=${code}`;
            document.getElementById('qr-info').innerHTML = `
                <b>NGÂN HÀNG:</b> MB BANK<br>
                <b>SỐ TK:</b> 79991312006<br>
                <b>SỐ TIỀN:</b> <span style="color:red; font-weight:900">${parseInt(price).toLocaleString()}đ</span><br>
                <b>NỘI DUNG:</b> <span style="color:red; font-weight:900">${code}</span>
            `;
        }

        // TELEGRAM SYNC
        const user = tg.initDataUnsafe?.user;
        if (user) {
            const name = user.first_name + (user.last_name ? " " + user.last_name : "");
            document.getElementById('u-name').innerText = name;
            document.getElementById('d-name').innerText = name;
            document.getElementById('u-detail').innerText = `@${user.username || 'no_user'} | ID: ${user.id}`;
            if (user.photo_url) {
                document.getElementById('u-avatar').src = user.photo_url;
                document.getElementById('d-avatar').src = user.photo_url;
            }
        }

        // SAKURA GENERATOR (5 PETALS)
        for (let i = 0; i < 15; i++) {
            const s = document.createElement('div');
            s.className = 'sakura';
            for (let j = 0; j < 5; j++) s.appendChild(document.createElement('div')).className = 'petal';
            s.style.left = Math.random() * 100 + 'vw';
            s.style.animationDuration = (Math.random() * 4 + 6) + 's';
            s.style.animationDelay = Math.random() * 5 + 's';
            document.getElementById('sakura-box').appendChild(s);
        }

        render();
    </script>
</body>
</html>
